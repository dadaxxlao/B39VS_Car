# B39VS_Car 智能小车项目

这是一个基于Arduino的智能小车项目，包含传感器控制、电机驱动、路径规划等功能。项目使用PlatformIO作为开发环境。

## 项目结构

```
B39VS_Car/
├── src/                    # 源代码目录
│   ├── Arm/                # 机械臂控制模块
│   ├── Control/            # 控制算法模块
│   ├── Motor/              # 电机驱动模块
│   ├── Sensor/             # 传感器接口模块
│   ├── Test/               # 测试程序
│   └── Utils/              # 工具类和配置
├── platformio.ini          # PlatformIO配置文件
├── Design.md               # 设计文档
└── get-platformio.py       # PlatformIO安装辅助脚本
```

## 硬件要求

- Arduino Mega 2560 (ATmega2560)
- 电机驱动模块 (L298N或类似)
- 红外线传感器阵列 (I2C接口)
- TCS34725颜色传感器 (I2C接口)
- 超声波传感器 (HC-SR04或类似)
- 舵机 (SG90或类似)
- RGB LED灯环 (可选)

## 环境搭建

### 安装PlatformIO

本项目使用PlatformIO作为开发环境，它是一个跨平台的嵌入式开发工具。

#### 方法1：通过VS Code扩展安装

1. 安装[Visual Studio Code](https://code.visualstudio.com/)
2. 打开VS Code扩展市场，搜索并安装"PlatformIO IDE"扩展
3. 安装完成后重启VS Code

#### 方法2：使用项目附带的安装脚本

```bash
python get-platformio.py
```

### 克隆项目

```bash
git clone https://github.com/yourusername/B39VS_Car.git
cd B39VS_Car
```

### 打开项目

1. 在VS Code中，选择"文件" -> "打开文件夹"，然后选择克隆的B39VS_Car目录
2. PlatformIO将自动识别项目并加载配置

## 编译和上传

### 编译项目

在VS Code中，点击底部状态栏的"Build"按钮，或使用快捷键:
- Windows/Linux: `Ctrl+Alt+B`
- macOS: `Cmd+Alt+B`

### 上传到Arduino

1. 将Arduino Mega通过USB连接到电脑
2. 在VS Code中，点击底部状态栏的"Upload"按钮，或使用快捷键:
   - Windows/Linux: `Ctrl+Alt+U`
   - macOS: `Cmd+Alt+U`

## 运行测试

项目包含多个测试模块，每次只能运行一个测试。要选择要运行的测试，需要修改`platformio.ini`文件中的`build_flags`：

```ini
[env:arduino_mega]
platform = atmelavr
board = megaatmega2560
framework = arduino
build_flags = -D TEST_INFRARED  # 修改这一行来选择测试
```

可用的测试选项:
- `TEST_INFRARED` - 红外线传感器测试
- `TEST_COLOR_SENSOR` - 颜色传感器测试
- `TEST_COLOR_CALIBRATION` - 颜色传感器校准测试
- `TEST_CALIBRATION` - 传感器校准测试
- `TEST_ULTRASONIC` - 超声波传感器测试
- `TEST_MULTIPLE_JUNCTION_DETECTION` - 路口检测测试
- `TEST_SENSOR_MANAGER` - 传感器管理器测试

修改后保存文件，然后执行编译和上传操作。

## 串口监视器

测试程序会通过串口输出调试信息。要查看这些信息：

1. 在VS Code中，点击底部状态栏的"Serial Monitor"按钮
2. 或者使用外部串口工具，波特率设置为9600

## 颜色传感器校准和使用

颜色传感器对于小车的寻路功能至关重要，需要正确校准以确保准确识别不同颜色。

### 颜色传感器校准流程

1. **运行校准程序**：
   - 在`platformio.ini`中设置：`build_flags = -D TEST_COLOR_CALIBRATION`
   - 编译并上传程序到Arduino
   - 打开串口监视器（波特率9600）

2. **校准步骤**：
   - 选择"1"进入校准模式
   - 将传感器依次放在红色、蓝色、黄色、白色和黑色表面上
   - 每种颜色放好后按"S"键开始采样
   - 系统会采集10个样本并计算平均值
   - 完成所有颜色校准后，系统将显示建议的阈值设置

3. **应用校准结果**：
   - 记录校准过程中显示的阈值建议值
   - 将这些值复制到`src/Sensor/ColorSensor.cpp`文件的`initColorThresholds()`函数中
   - 或者使用代码中已实现的基于RGB比例的识别算法

4. **测试颜色识别**：
   - 校准完成后，按"T"进入测试模式
   - 或者重新启动后选择"2"直接进入测试模式
   - 系统将持续显示识别结果，可以验证校准效果

### 颜色传感器实现原理

我们的颜色传感器基于TCS34725芯片，实现了两种颜色识别方法：

1. **阈值法**：使用固定的RGB阈值范围判断颜色
2. **RGB比例法**：计算RGB各通道占总亮度的比例来判断颜色（更稳健，不易受环境光强度影响）

可以通过校准过程确定哪种方法在您的环境中表现更好。

### 颜色传感器使用提示

- 保持传感器与被测表面的距离一致（约1-2cm）
- 避免环境光直接照射传感器
- 不同光照条件下可能需要重新校准
- 若识别不稳定，可以尝试调整传感器增益和积分时间
- 颜色校准应在实际使用环境中进行，以获得最佳效果

## 传感器校准

1. 运行`TEST_CALIBRATION`测试
2. 按照串口输出的指示进行操作
3. 完成校准后，将输出的参数添加到相应的配置文件中

## 故障排除

### 编译错误

- **多重定义错误**: 确保一次只定义一个测试标志
- **找不到库**: 运行`pio lib install`安装所需库
- **端口未找到**: 检查USB连接或驱动安装

### 颜色传感器常见问题

- **无法识别颜色**: 检查I2C连接，确保电源稳定，尝试重新校准
- **识别结果不稳定**: 调整传感器位置，避免环境光干扰，增加采样次数
- **颜色混淆**: 重新校准，调整RGB比例判断阈值
- **传感器不响应**: 检查地址设置（默认0x29），重启Arduino

### 硬件连接

参考`src/Utils/Config.h`文件中的引脚定义，确保硬件连接正确。

## 贡献

欢迎提交问题报告和改进建议！

## 许可

[添加适当的许可信息]

## 颜色识别功能说明

### 最新更新：HSV颜色空间识别算法

我们已经实现了基于HSV颜色空间的颜色识别算法，相比传统的RGB识别方法有以下优势：

1. **更强的环境适应性**：HSV空间将颜色分解为色相(Hue)、饱和度(Saturation)和明度(Value)，其中色相与光照强度无关，因此对环境光变化更为稳定。

2. **更直观的颜色表示**：HSV颜色空间更符合人类对颜色的感知，使得颜色的区分和分类更加直观。

3. **更精确的颜色识别**：通过同时使用HSV和RGB两种算法，并优先使用HSV结果，可以提高颜色识别的准确率。

### 详细测试步骤

1. **准备工作**：
   - 确保TCS34725颜色传感器正确连接到Arduino的I2C总线（SDA/SCL引脚）
   - 准备用于测试的红、黄、蓝、黑、白五种颜色样本
   - 准备一个按钮连接到Arduino的引脚36（如需使用其他引脚，请修改测试代码）

2. **编译和上传HSV测试程序**：
   ```bash
   # 在命令行中执行
   pio run -e test_color_hsv -t upload
   ```
   或在PlatformIO IDE中选择`test_color_hsv`环境并点击上传按钮

3. **打开串口监视器**：
   - 波特率设置为115200
   - 程序启动后将显示欢迎信息和操作指南

4. **操作说明**：
   - 程序支持三种测试模式：颜色检测、颜色校准和原始数据显示
   - 短按按钮：执行当前模式的操作
   - 长按按钮：切换测试模式或校准颜色

5. **颜色检测模式（1）**：
   - 这是程序启动时的默认模式
   - 将传感器放在待测颜色上方1-2cm处
   - 短按按钮进行检测
   - 系统将显示：
     * 检测到的颜色（RGB算法结果）
     * HSV算法结果
     * 综合结果（优先采用HSV算法）
     * 原始传感器数据和转换后的RGB比例及HSV值

6. **颜色校准模式（2）**：
   - 长按按钮切换到此模式
   - 默认校准红色，可通过长按切换校准目标颜色
   - 将传感器放在目标颜色上方
   - 短按按钮开始校准
   - 系统会采集10个样本并输出：
     * 原始RGB值和清晰度值
     * RGB比例值
     * HSV值
     * 建议的RGB和HSV阈值设置
   - 记录这些阈值，稍后可更新到`ColorSensor.cpp`文件中

7. **原始数据模式（3）**：
   - 长按按钮两次切换到此模式
   - 短按按钮显示原始传感器数据
   - 使用此模式可以观察不同颜色的原始数据特征

8. **实际测试流程示例**：
   1. 启动程序，系统进入颜色检测模式
   2. 将传感器放在红色样本上，短按按钮
   3. 观察识别结果和HSV/RGB值
   4. 长按按钮切换到校准模式
   5. 将传感器放在红色样本上，短按按钮进行校准
   6. 记录显示的建议阈值
   7. 长按按钮切换校准目标为黄色
   8. 重复步骤5-6对黄色进行校准
   9. 依次对蓝色、黑色和白色进行校准
   10. 长按按钮切换回检测模式，测试校准效果

9. **阈值更新**：
   - 完成所有颜色校准后，打开`src/Sensor/ColorSensor.cpp`文件
   - 找到`initColorThresholds()`函数
   - 根据校准结果更新HSV阈值部分
   - 重新编译并上传程序

10. **结果验证**：
    - 上传修改后的程序
    - 再次运行HSV测试程序
    - 检查所有颜色的识别准确性
    - 如有必要，微调阈值并重复测试

### 技术实现

- **RGB到HSV的转换**：实现了高效的RGB到HSV转换算法，适用于嵌入式环境。
- **特殊情况处理**：处理了红色跨越0度/360度的特殊情况，确保所有颜色都能正确识别。
- **多层识别策略**：当HSV识别失败时，自动退回到RGB识别，保证识别的鲁棒性。

### 颜色校准提示

1. **环境光影响**：校准时尽量保持环境光稳定，避免强光直射或光线过暗。
2. **传感器位置**：保持传感器与目标颜色的距离一致（建议1-2cm），避免阴影干扰。
3. **多次校准**：对同一颜色进行多次校准，取平均值以提高准确性。
4. **特殊颜色处理**：
   - 红色：注意设置跨越0度/360度的阈值（通常色相在350-10度之间）
   - 黑色：主要通过低明度（V值<0.15）识别
   - 白色：主要通过低饱和度（S值<0.1）和高明度（V值>0.9）识别
5. **排除异常值**：校准过程中观察数值，如果某个样本明显异常，可以重新采样

### 测试故障排除

1. **传感器无法初始化**：
   - 检查I2C连接是否正确
   - 验证传感器地址（默认0x29）
   - 确保电源稳定且电压适当

2. **颜色识别不稳定**：
   - 增加采样次数（默认为10个）
   - 调整传感器增益和积分时间
   - 检查传感器是否受到外部光源干扰

3. **颜色混淆问题**：
   - 红色与黄色混淆：调整色相阈值，确保红色的阈值正确处理了跨越0度的情况
   - 黑色与深蓝色混淆：同时检查色相和明度，提高黑色的明度上限
   - 白色与浅黄色混淆：调整白色的饱和度上限

4. **无法识别特定颜色**：
   - 重新对该颜色进行校准
   - 检查该颜色的HSV阈值设置
   - 尝试调整传感器位置和角度

### 调试信息

颜色传感器类提供了丰富的调试信息输出功能：

- `debugPrint()`: 输出当前传感器数据和识别结果
- `printRawValues()`: 输出原始传感器数据
- `calibrateColor()`: 进行颜色校准并输出建议的阈值设置

